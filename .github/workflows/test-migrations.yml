name: Test Alembic Migrations

on:
  pull_request:
    paths:
      - 'backend/app/alembic/versions/**'
      - 'backend/app/db/initialize.py'
      - 'backend/scripts/prestart.sh'
      - 'backend/alembic.ini'
      - 'backend/app/alembic/env.py'
      - 'backend/Dockerfile'
      - 'backend/pyproject.toml'
      - 'docker-compose.yml'
      - '.github/workflows/test-migrations.yml'

jobs:
  test-migrations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test environment file
        run: |
          cp .env.example .env
          # Override with secure test values
          echo "POSTGRES_PASSWORD=test_password_$(openssl rand -hex 8)" >> .env
          echo "JWT_SECRET_KEY=$(openssl rand -base64 32)" >> .env
          echo "SUPER_USER_PASSWORD=test_admin_$(openssl rand -hex 8)" >> .env

      - name: Build Docker Compose services
        run: docker compose build

      - name: Start database service
        run: docker compose up -d db

      - name: Wait for database to be healthy
        run: |
          # Extract database configuration from .env
          POSTGRES_USER=$(grep "^POSTGRES_USER=" .env | cut -d '=' -f2)

          echo "Waiting for database to be ready..."
          timeout 60 bash -c "until docker compose exec -T db pg_isready -U $POSTGRES_USER; do sleep 2; done"
          echo "✓ Database is ready"

      - name: Run prestart script (migrations + initialization)
        run: |
          echo "Running prestart script (migrations + database initialization)..."
          docker compose run --rm pre-start
          echo "✓ Prestart script completed successfully"

      - name: Verify migrations applied
        run: |
          # Extract database configuration from .env
          POSTGRES_USER=$(grep "^POSTGRES_USER=" .env | cut -d '=' -f2)
          POSTGRES_DB=$(grep "^POSTGRES_DB=" .env | cut -d '=' -f2)

          echo "Checking alembic version..."
          docker compose exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT version_num FROM alembic_version;"
          echo "✓ Alembic version table exists and contains migration version"

      - name: Verify user table exists
        run: |
          # Extract database configuration from .env
          POSTGRES_USER=$(grep "^POSTGRES_USER=" .env | cut -d '=' -f2)
          POSTGRES_DB=$(grep "^POSTGRES_DB=" .env | cut -d '=' -f2)

          echo "Checking user table schema..."
          docker compose exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "\d+ \"user\""
          echo "✓ User table created successfully"

      - name: Verify super user created
        run: |
          # Extract configuration from .env
          POSTGRES_USER=$(grep "^POSTGRES_USER=" .env | cut -d '=' -f2)
          POSTGRES_DB=$(grep "^POSTGRES_DB=" .env | cut -d '=' -f2)
          SUPER_USER_NAME=$(grep "^SUPER_USER_NAME=" .env | cut -d '=' -f2)

          echo "Checking super user '$SUPER_USER_NAME'..."
          USER_COUNT=$(docker compose exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -t -c "SELECT COUNT(*) FROM \"user\" WHERE username='$SUPER_USER_NAME';" | tr -d '[:space:]')

          if [ "$USER_COUNT" -eq 1 ]; then
            echo "✓ Super user '$SUPER_USER_NAME' created successfully"
          else
            echo "✗ Super user '$SUPER_USER_NAME' not found or duplicate entries (count: $USER_COUNT)"
            exit 1
          fi

      - name: Display migration summary
        if: always()
        run: |
          # Extract database configuration from .env
          POSTGRES_USER=$(grep "^POSTGRES_USER=" .env | cut -d '=' -f2)
          POSTGRES_DB=$(grep "^POSTGRES_DB=" .env | cut -d '=' -f2)

          echo ""
          echo "=== Migration Test Summary ==="
          docker compose exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "
            SELECT
              version_num as current_revision
            FROM alembic_version;
          " || echo "Could not retrieve migration version"

          echo ""
          echo "=== Database Tables ==="
          docker compose exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "\dt" || echo "Could not list tables"

      - name: Show service logs on failure
        if: failure()
        run: docker compose logs

      - name: Clean up
        if: always()
        run: docker compose down -v --remove-orphans
